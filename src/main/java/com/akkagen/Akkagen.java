/*
 * Developed  by Kiran Yedavalli on 8/7/18 12:27 PM
 * Last Modified 8/6/18 2:33 PM
 * Copyright (c) 2018. All rights reserved.
 */

package com.akkagen;

import akka.actor.ActorRef;
import akka.actor.ActorSystem;
import com.akkagen.exceptions.AkkagenException;
import com.akkagen.models.*;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.Properties;


/*
 * This Java source file was generated by the Gradle 'init' task.
 */
public class Akkagen {

    private static volatile Akkagen akkagen;
    private final Logger logger = LoggerFactory.getLogger(Akkagen.class);
    private ActorSystem system;
    private ServiceProviderFactory spFactory;
    private ActorRef monitor;

    private Akkagen() {

    }

    public Properties getProperties(){
        Properties props = new Properties();
        InputStream input = null;
        try{
            input = this.getClass().getClassLoader().getResourceAsStream("akkagen.properties");
            props.load(input);
        }
        catch(IOException e){
            logger.error("Unable to read akkagen.properties file");
            throw new AkkagenException("Unable to read akkagen.properties file");
        }
        finally{
            if(input!=null){
                try{
                    input.close();
                }
                catch(IOException e){
                    logger.error("Unable to close akkagen.properties file");
                    throw new AkkagenException("Unable to close akkagen.properties file");
                }
            }
        }
        return props;
    }

    public void initialize(){
        this.system = ActorSystem.create("akkagen");
        this.spFactory = new ServiceProviderFactory(system, getProperties());
        this.monitor = system.actorOf(Monitor.props(system, getProperties()), "monitor-actor");
    }

    public static Akkagen getInstance(){
        if(akkagen == null){
            synchronized (Akkagen.class){
                if(akkagen == null){
                    akkagen = new Akkagen();
                }
            }
        }
        return akkagen;
    }

    public ActorSystem getSystem() {
        return this.system;
    }

    public ServiceProviderFactory getServiceProviderFactory() {
        return this.spFactory;
    }

    public Logger getLogger() {
        return this.logger;
    }

    public static void main(String[] args) {
        // The following order is important
        Akkagen.getInstance().initialize();

        // Management

        Akkagen.getInstance().getServiceProviderFactory().initializeMgmtRestServer();
        Akkagen.getInstance().getServiceProviderFactory().initializeMgmtServiceProvider(PathConstants.__TX_REST,
                TxRestEngineDefinition.class,
                TxRestEngineDefinition.inputDataValidator,
                TxRestEngineDefinition.methodValidator);
        Akkagen.getInstance().getServiceProviderFactory().initializeMgmtServiceProvider(PathConstants.__RX_REST,
                RxRestEngineDefinition.class,
                RxRestEngineDefinition.inputDataValidator,
                RxRestEngineDefinition.methodValidator);
        Akkagen.getInstance().getServiceProviderFactory().initializeMgmtServiceProvider(PathConstants.__RX_REST_STATS,
                RxRestEngineStatsDefinition.class,
                RxRestEngineStatsDefinition.inputDataValidator,
                RxRestEngineStatsDefinition.methodValidator);

        // Engines

        Akkagen.getInstance().getServiceProviderFactory().initializeEngineProviders();

        Akkagen.getInstance().getLogger().debug("***** Akkagen Started *****");
    }
}
